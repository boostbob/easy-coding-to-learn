æœ¬åœ°çš„ go build ç¼–è¯‘çš„æ—¶å€™é»˜è®¤æ˜¯å¯ç”¨ C/C++  æ”¯æŒçš„ï¼Œå¯¹åº”çš„ç¼–è¯‘å¼€å…³æ˜¯ CGO_ENABLEDï¼Œäº¤å‰æ„å»ºéœ€è¦ä½¿ç”¨ CGO_ENABLED=1ï¼Œæœ€ç®€å•çš„ CGO ç¨‹åºå¦‚ä¸‹:

```go
package main

// cgo enabled default

import "C"

func main() {}
```

æ²¡é”™ï¼Œimport "C" å¯ä»¥å¯¼å…¥ C çš„ç±»å‹ï¼Œè¡¨æ˜éœ€è¦è°ƒç”¨ C åº“ï¼ŒCGO çš„ç‰¹è‰²ä¹‹ä¸€å°±å¯ä»¥ç›´æ¥åœ¨ go æ–‡ä»¶é‡Œç¼–å†™ C è¯­è¨€çš„æ¨¡å—ï¼Œç¼–å†™çš„ C ä»£ç éƒ¨åˆ†å¿…é¡»åœ¨ import "C" ä¹‹ä¸Šï¼Œimport è¯­å¥ä¹‹å‰ä¸èƒ½æœ‰ç©ºè¡Œï¼Œä¸‹é¢çš„ä¾‹å­è°ƒç”¨äº† C çš„ puts å‡½æ•°:

```go
package main 

//#include <stdio.h>
import "C"

func main() {
  C.puts(C.CString("hi, cgo lib"))
}
```

C.puts è°ƒç”¨ puts å‡½æ•°ï¼Œå®ƒçš„åŸå‹æ˜¯: 

```go
int puts(const char *str)
C.CString æ˜¯æŠŠ go çš„ string è½¬æ¢åˆ° C çš„ *charï¼Œä¸è¿‡è¿™ä¸ªè½¬æ¢ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼Œéœ€ç”¨è°ƒç”¨ free é‡Šæ”¾ï¼Œä¸‹é¢æ˜¯ CString çš„ç­¾å:

// Go string to C string
// The C string is allocated in the C heap using malloc.
// It is the caller's responsibility to arrange for it to be
// freed, such as by calling C.free (be sure to include stdlib.h
// if C.free is needed).
func C.CString(string) *C.char
```

å’Œ C.CString ç›¸ä¼¼æ˜¯çš„ C.CBytes([]byte) unsafe.Pointer å‡½æ•°ç”¨äºè½¬æ¢ go çš„ []byte åˆ‡ç‰‡ï¼Œä¹Ÿéœ€è¦è‡ªè¡Œ freeï¼Œä¸Šé¢çš„ä¾‹å­å®Œæ•´çš„ä»£ç æ˜¯:

```go
//#include <stdio.h>
//#include <stdlib.h>
import "C"
import "unsafe"

func main() {
  cstr := C.CString("hi, cgo lib")
  C.puts(cstr)
  C.free(unsafe.Pointer(cstr))
}
```

unsafe.Pointer è·å¾—æŒ‡é’ˆçš„å€¼ï¼Œä¼ é€’ç»™ C çš„ free å‡½æ•°ï¼Œfree å‡½æ•° stdlib.h ä¸­ï¼Œæ‰€ä»¥éœ€è¦åŒ…å«ã€‚åè¿‡æ¥ï¼Œå¦‚æœæŠŠ C çš„ *char æ¢æ¢æˆ go çš„ stringï¼Œå¯ä»¥ä½¿ç”¨ C.GoString å‡½æ•°ï¼Œç±»ä¼¼çš„ä¹Ÿæœ‰ func C.GoBytes(unsafe.Pointer, C.int) []byteã€‚

```go
str := C.GoString(cstr)
fmt.Println(str)
```

CGO ä¼šè‡ªåŠ¨æ„å»ºå½“å‰ç›®å½•ä¸‹çš„ C æºæ–‡ä»¶ï¼Œæ‰€ä»¥æŠŠå¯ä»¥æŠŠä¸Šé¢ C çš„éƒ¨åˆ†ç‹¬ç«‹å‡ºæ¥ï¼Œè¿™æ ·å¯ä»¥å®ç° C çš„æ¨¡å—åŒ–:

```go
// say.h
void Say(const char* s);

// say.c
#include "say.h"
#include <stdio.h>

void Say(const char* s) {
    puts(s);
}

// main.go
package main

//#include "say.h"
import "C"

func main() {
  C.Say(C.CString("hi, cgo"))
}
```

è¯·æ³¨æ„ï¼Œä¸èƒ½ä½¿ç”¨ go run main.go æ¥è¿è¡Œäº†ï¼Œè¦ä½¿ç”¨ go run . æ¥è¿è¡Œï¼Œä¸ä»… go å¯ä»¥è°ƒç”¨ C æ¨¡å—çš„å‡½æ•°ï¼ŒC çš„å‡½æ•°ä¹Ÿå¯ä»¥ç”± go æ¥å®ç°:

```go
// say.h
void Say(char* s);

// say.go
package main

import "C"

import "fmt"

//export Say
func Say(s *C.char) {
  fmt.Print(C.GoString(s))
}

// main.go
package main

//#include <say.h>
import "C"

func main() {
  C.Say(C.CString("hi, cgo"))
}
```

say.h å¤´æ–‡ä»¶ç”³æ˜äº† Say å‡½æ•°çš„ç­¾åï¼Œä½†æ˜¯å®ƒä½¿ç”¨ say.go æ¥å®ç°çš„å‡½æ•°ä½“ï¼Œæ³¨æ„ä¸¤ç‚¹:  
1. // export Say æ˜¯å¿…é¡»çš„ï¼Œè¡¨ç¤ºæŠŠ go çš„å‡½æ•°å’Œå¯¼å‡ºä¸º C çš„å‡½æ•°  
2. å’Œ C æ¨¡å—åŒ–ä¸€æ ·ï¼Œä¹Ÿå¾—ä½¿ç”¨ go run . è¿è¡Œå¦åˆ™é“¾æ¥å¤±è´¥  

![](https://develop-developer.oss-cn-hangzhou.aliyuncs.com/images/7WA4J6QJoMxA5zoCj-C8Tj3ncpFc_iDdXi6kQWmU1o.png?x-oss-process=style/txt-water)

å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸‰ä¸ªæ–‡ä»¶åˆå¹¶åˆ°ä¸€ä¸ª go æ–‡ä»¶é‡Œï¼Œåˆå¯ä»¥ä½¿ç”¨ go run main.go è¿è¡Œäº†ã€‚

```go
package main

//void Say(char* s);
import "C"

import (
  "fmt"
)

func main() {
  C.Say(C.CString("hi, cgo"))
}

//export Say
func Say(s *C.char) {
  fmt.Println(C.GoString(s))
}
```

CGO çœ‹ä¼¼å®ç°äº† C å’Œ Go çš„ç›´æ¥è°ƒç”¨ï¼Œå®æ–½ä¸Šå¹¶éå¦‚æ­¤ï¼Œå½“å‘ç° import "C" æ—¶ï¼Œç¼–è¯‘ä¼šäº§ç”Ÿ C å’Œ Go ä¹‹é—´çš„ä¸­ä»‹ä»£ç ï¼Œæ‰§è¡Œ go tool cgo main.go å¯ä»¥æŸ¥çœ‹åˆ°ä¸­é—´ä»£ç :

```
27-call-c-module[master*] ğŸ go tool cgo main.go
27-call-c-module[master*] ğŸ tree _obj
_obj
â”œâ”€â”€ _cgo_export.c
â”œâ”€â”€ _cgo_export.h
â”œâ”€â”€ _cgo_flags
â”œâ”€â”€ _cgo_gotypes.go
â”œâ”€â”€ _cgo_main.c
â”œâ”€â”€ main.cgo1.go
â””â”€â”€ main.cgo2.c
```

CGO è¿˜æ”¯æŒ # cgo  CFLAGS LDFLAGS è®¾å®šç¼–è¯‘è¿æ¥å‚æ•°ï¼Œæ›´å¤š CGO çš„çŸ¥è¯†å‚è€ƒå®˜ç½‘:   
1. https://golang.org/cmd/cgo  
2. https://blog.golang.org/cgo  


æœ¬ç« èŠ‚çš„ä»£ç  [https://github.com/developdeveloper/go-demo/tree/master/27-call-c-module](https://github.com/developdeveloper/go-demo/tree/master/27-call-c-module)
