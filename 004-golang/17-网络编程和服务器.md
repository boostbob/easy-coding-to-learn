åœ¨ OSI ä¸ƒå±‚ç½‘ç»œæ¨¡å‹ä¸­ï¼ŒHTTPã€DNSã€FTP ç­‰åè®®å±äºåº”ç”¨å±‚çš„ï¼Œå¾€ä¸‹ TCPã€UDP å±äºä¼ è¾“å±‚åè®®ï¼Œå†å¾€ä¸‹æ˜¯ IPã€ICMP ç­‰åè®®ï¼Œé€šå¸¸è¯´çš„ç½‘ç»œç¼–ç¨‹ä¸»è¦åŸºäº TCPã€UDP ä»¥åŠåŸºäºä¸Šå±‚åè®®çš„åº”ç”¨ã€‚

åœ¨ç½‘ç»œä¸­ä¾é  IP åœ°å€å¯ä»¥è¯†åˆ«åˆ°ä¸€å°ä¸»æœºï¼Œè¦å®šä½éƒ½è¿›ç¨‹è¿˜éœ€è¦åŠ ä¸Šç«¯å£å·ï¼Œä¸¤ä¸ªä¸åŒä¸»æœºä¸Šçš„è¿›ç¨‹è¦é€šè®¯è¿˜å¾—è¯­è¨€äº’é€šï¼Œè¿™å°±æ˜¯åè®®ã€‚è¿™ç§é€šè®¯åœ¨ç¼–ç¨‹é‡Œç»å¸¸æˆä¸º socket ç¼–ç¨‹ï¼Œç¿»è¯‘ä¸ºå¥—æ¥å­—ç¼–ç¨‹ï¼Œå®ƒæŠŠåº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¸­é—´åšäº†ä¸€ä¸ªæŠ½è±¡ï¼ŒæŠŠ TCP/IP çš„å¤æ‚æ¦‚å¿µæŠ½è±¡æˆå‡ ä¸ªå‡½æ•°æ¥å£å®šä¹‰ï¼Œå®ç°äº†ä¸åŒä¸»æœºä¹‹é—´çš„è¿›ç¨‹é€šè®¯ã€‚è¿™ä¸ª socket å¥—æ¥å­—é¦–å…ˆæ˜¯åœ¨ä¼¯å…‹åˆ© BSD ç³»ç»Ÿé‡Œå‘æ‰¬å…‰å¤§ï¼Œsocket æœ¬æ„æ˜¯æ’åº§ï¼Œæœ‰äººè§‰å¾—ç¿»è¯‘ä¸ºå¥—æ¥å£æ›´åˆé€‚ï¼Œæ—¢ç„¶æ˜¯æŠ½è±¡çš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯ä½ ä¸ç®¡ä½¿ç”¨å“ªä¸ªç¼–ç¨‹è¯­è¨€ï¼Œéƒ½æ˜¯ä¸€æ ·çš„ç¼–ç¨‹å¥—è·¯ã€‚

ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†å¦‚ä½•å»ºä¸€ä¸ª tcp çš„æœåŠ¡ç«¯ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸ºå®¢æˆ·ç«¯æä¾›æ—¶é—´æŸ¥è¯¢æœåŠ¡ã€‚

```go
func handleClient(conn net.Conn) {  
  defer conn.Close()
  str := fmt.Sprintf("%s\n", time.Now().Format("2006-01-02 15:04:05"))
  conn.Write([]byte(str))
}

func startTcpServer() {
  listener, _ := net.Listen("tcp", "127.0.0.1:3000")
  defer listener.Close()
  for {
    conn, _ := listener.Accept()
    go handleClient(conn)
  }
}
```

ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæ²¡æœ‰è¿›è¡Œé”™è¯¯åˆ¤æ–­ï¼ŒstartTcpServer æ‰§è¡Œåå¼€å§‹ listen ç›‘å¬æœ¬åœ°çš„ 3000 ç«¯å£ï¼Œç„¶åé™·å…¥æ­»å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯æ¥è¿æ¥ï¼Œç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯ listen.Accept() çš„è°ƒç”¨å°†ä¼šç­‰å¾…è¿æ¥ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥çš„ä¼šåè¢«ç³»ç»Ÿå”¤é†’ï¼Œè¿™æ—¶å€™å°†è·å¾—ä¸€ä¸ª net.Conn å¯¹è±¡ï¼Œç„¶åå¯åŠ¨äº†ä¸€ä¸ªåç¨‹å»ä¸ºå®¢æˆ·ç«¯æœåŠ¡ï¼Œå› ä¸º go å…³é”®å­—çš„ä¾¿åˆ©æ€§ï¼Œå®ƒå·²ç»å¯ä»¥å’Œå¤šä¸ªå®¢æˆ·ç«¯é€šè®¯äº†ï¼ŒæŠŠå½“å‰æ—¶é—´é€šè¿‡ net.Conn å†™å…¥åˆ°å¥—æ¥å­—æ•°æ®ç¼“å†²åŒºåï¼Œå®ƒä¸»åŠ¨çš„å…³é—­äº† tcp è¿æ¥ã€‚

æ€ä¹ˆæµ‹è¯•å‘¢? ä¸ç”¨ç€æ€¥å†™ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å…ˆç”¨ telnet å‘½ä»¤æ¥æµ‹è¯•ä¸€ä¸‹:

```go
Desktop ğŸ telnet 127.0.0.1 3000
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
2021-01-09 17:09:00Connection closed by foreign host.
```

æ‰“å°æ—¶é—´åï¼Œtelnet æç¤º "Connection closed by foreign host"ï¼Œè¯´æ˜çš„ç¡®è¿œç¨‹ server ä¸»åŠ¨æŠŠè¿æ¥ close æ‰äº†ã€‚

net.Listen è¿”å›çš„æ˜¯ net.Listener æ¥å£å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•:

```go
type Listener interface {
  Accept() (Conn, error)
  Close() error
  Addr() Addr
}
```

Accept å‡½æ•°æ‰§è¡Œåå¾—åˆ° net.Conn æ¥å£å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†å¦‚ä¸‹æ–¹æ³•:

```go
type Conn interface {
  Read(b []byte) (n int, err error) // è¯»
  Write(b []byte) (n int, err error) // å†™ 
  Close() error // å…³é—­
  LocalAddr() Addr // æœ¬åœ°é€šè®¯åœ°å€
  RemoteAddr() Addr // è¿œç«¯é€šè®¯åœ°å€
  SetDeadline(t time.Time) error // è®¾ç½®ä¸æ´»è·ƒæ—¶ä¿æŒè¿æ¥çš„æ—¶é—´
  SetReadDeadline(t time.Time) error 
  SetWriteDeadline(t time.Time) error
}
```

æ€»ç»“ä¸€ä¸‹ç¼–å†™ Tcp Server çš„å¥—è·¯:  
1. è·å¾—ä¸€ä¸ª Listener ç›‘å¬å¯¹è±¡  
2. è°ƒç”¨ Accept ç­‰å¾…å®¢æˆ·ç«¯æ¥è¿æ¥  
3. è¿æ¥å»ºç«‹ååå¾€ Conn å¯¹è±¡é‡Œè¯»å’Œå†™æ•°æ®  
4. ä¸éœ€è¦çš„æ—¶å€™å¯ä¸»åŠ¨å…³é—­è¿æ¥  

ç›¸å¯¹äº server ç¼–å†™ client åˆ™æ›´åŠ ç®€å•:

```go
func startTcpClient() {
  conn, _ := net.Dial("tcp", "127.0.0.1:3000")
  buf := make([]byte, 100)
  conn.Read(buf)
  fmt.Println(string(buf))
}
```

ä½¿ç”¨ net.Dial å‡½æ•°ï¼Œè¯·æ±‚ä¸æœ¬æœº 3000 ç«¯å£å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼ŒæˆåŠŸåè·å¾— net.TCPConn å¯¹è±¡ï¼Œæ¥ç€ä»é‡Œé¢è¯»å–æ•°æ®æ˜¾ç¤ºå‡ºæ¥ã€‚


ä¸è¿‡è¿™ä¸¤ä¸ªä¾‹å­å¤ªè¿‡äºç®€å•ï¼ŒçœŸå®çš„ tcp é€šè®¯ç¨‹åºé¢ä¸´å¾ˆå¤šé—®é¢˜:  
1. æœåŠ¡ç«¯å¼€å¯ç­‰å¾…æ—¶å€™ï¼Œå¯èƒ½ç«¯å£è¢«å ç”¨äº†æˆ–è€…è¢«é˜²ç«å¢™é˜»æ­¢ï¼Œé€ æˆå¯åŠ¨æœåŠ¡ç«¯å¤±è´¥  
2. ç”±äº Server ç«¯çš„è´Ÿè½½èƒ½åŠ›æˆ–è€…ç½‘ç»œä¸ç¨³å®šï¼Œå¯èƒ½å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ä¼šå¤±è´¥  
3. å»ºç«‹è¿æ¥åï¼Œç½‘ç»œä¸ç¨³å®š Read å’Œ Write å‡½æ•°å¯èƒ½ä¸ä¼šæŒ‰é¢„æœŸé‚£æ ·å·¥ä½œ  
4. tcp æ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œå¾€å¾€éœ€è¦å¤šæ¬¡è¯»å†™ï¼Œä½†æ˜¯æ¯æ¬¡è¯»å†™çš„æ•°æ®ä¸ä¸€å®šæ˜¯å®Œæ•´çš„ä¸šåŠ¡å†…å®¹(ç²˜åŒ…ã€ä¸¢åŒ…)  
5. å»ºç«‹å¥½çš„è¿æ¥ä¹Ÿå¯èƒ½å› ä¸ºç½‘ç»œå› ç´ è¢«æ–­å¼€ï¼Œéœ€è¦å®ç°å¿ƒè·³å’Œè‡ªåŠ¨é‡è¿æœºåˆ¶ä¿è¯è½¯ä»¶çš„å¯ç”¨æ€§  


ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥æ˜¯é¡ºåºç¼–ç¨‹ï¼Œå¾ˆå¤šè¯­è¨€ç¼–å†™é«˜æ€§èƒ½çš„ç½‘ç»œç¨‹åºï¼Œéœ€è¦å¤šè¿›ç¨‹+å¤šçº¿ç¨‹+éé˜»å¡ I/O å¤šè·¯å¤ç”¨æ¥å®ç°ï¼Œä½†åœ¨ go è¿è¡Œæ—¶è¿™ä¸€å±‚ï¼Œé€šè¿‡å¯¹ goroutine å’Œéé˜»å¡ I/O å¤šè·¯å¤ç”¨æœºåˆ¶çš„æŠ½è±¡ï¼ŒçœŸå®çš„åº•å±‚ socket å¯¹è±¡æ˜¯éé˜»å¡çš„ï¼Œgo è¿è¡Œæ—¶æ‹¦æˆªäº†åº•å±‚çš„ socket è°ƒç”¨ï¼Œé€šè¿‡è°ƒåº¦ goroutine æ¥ç®€åŒ–äº†ç”¨æˆ·å±‚çš„ä»£ç ç¼–å†™ï¼Œæ¯”å¦‚å¯¹ socket å‘èµ· read è¯»æ•°æ®æ“ä½œï¼Œå¦‚æœå¯¹åº”çš„ socket æ–‡ä»¶æè¿°ç¬¦å¹¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œgo è¿è¡Œæ—¶æŠŠ socket æ–‡ä»¶æè¿°ç¬¦åŠ å…¥ç›‘å¬å™¨ï¼ŒåŒæ—¶ goroutine ä¹Ÿä¼šè¢«æŒ‚èµ·ï¼Œå½“ go è¿è¡Œæ—¶æ”¶åˆ°äº† socket æ–‡ä»¶æè¿°ç¬¦ ready çš„é€šçŸ¥åï¼Œä¼šç«‹åˆ»å”¤é†’æŒ‚èµ·çš„ goroutineï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨è¯»å– goroutine çš„è§’åº¦æ¥çœ‹ï¼Œå¥½åƒè‡ªå·±è¢«é˜»å¡ä½äº†ã€‚


åŠ ä¸€ä¸ªå¾ªç¯æ¥æµ‹è¯•ä¸€ä¸‹å¤šå®¢æˆ·ç«¯çš„æƒ…å†µ:

```go
func startTcpClient2() {
  for i := 0; i < 1024; i++ {
    conn, _ := net.Dial("tcp", "127.0.0.1:3000")
    log.Println(conn.LocalAddr().String() + " dial at " + time.Now().Format("15:04:05"))
  }
}
```

å®¢æˆ·ç«¯å»ºç«‹è¿æ¥åï¼Œæˆ‘ä»¬æ‰“å°å‡ºäº†æœ¬åœ°é€šè®¯åœ°å€å’Œå»ºç«‹è¿æ¥çš„æ—¶é—´ï¼Œä¸ºäº†ç¨‹åºè¿è¡Œçš„æ…¢ä¸€ç‚¹ï¼Œç»™ Server ç«¯åŠ ä¸€ä¸ªå»¶è¿Ÿï¼Œä¿®æ”¹å¦‚ä¸‹:

```go
func startTcpServer2() {
  listener, _ := net.Listen("tcp", "127.0.0.1:3000")
  defer listener.Close()
  for {
    time.Sleep(5 * time.Second)
    conn, _ := listener.Accept()
    log.Println("Accept at " + time.Now().Format("15:04:05"))
    go handleClient(conn)
  }
}
```

æœåŠ¡ç«¯æ¯ 5 ç§’é’Ÿè·å–åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œæµ‹è¯•ä»£ç :

```go
func Test_acceptBacklog(t *testing.T) {
  go startTcpServer2()
  startTcpClient2()
}
```

å¯åŠ¨å®¢æˆ·ç«¯ä»¥åè¾“å‡ºç±»ä¼¼å¦‚ä¸‹:

```go
......
2021/01/10 13:05:09 127.0.0.1:61901 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61902 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61903 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61904 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61905 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61906 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61907 dial at 13:05:09
2021/01/10 13:05:09 127.0.0.1:61908 dial at 13:05:09
2021/01/10 13:05:14 Accept at 13:05:14
2021/01/10 13:05:15 127.0.0.1:61909 dial at 13:05:15
2021/01/10 13:05:19 Accept at 13:05:19
2021/01/10 13:05:19 127.0.0.1:61917 dial at 13:05:19
2021/01/10 13:05:24 Accept at 13:05:24
......
```

æœ‰æ²¡æœ‰å‘ç°å¾ˆå¥‡æ€ªï¼Œå®¢æˆ·ç«¯çš„ dial åœ¨å¼€å§‹çš„æ—¶å€™å¾ˆå¿«å»ºç«‹äº†è¿æ¥ï¼Œä½†æ˜¯åˆ°åæ¥æ¯éš” 5 ç§’é’Ÿæ‰èƒ½å»ºç«‹ä¸€ä¸ªæ–°é“¾æ¥ï¼Œå¾ˆå¥‡æ€ªå§? è¿™è¯´æ˜å®¢æˆ·ç«¯çš„ dial å»ºç«‹è¿æ¥çš„è¡Œä¸ºå’ŒæœåŠ¡ç«¯çš„ accept è¡Œä¸ºå¹¶ä¸æ˜¯åŒæ­¥çš„ã€‚äº‹å®ä¸Š accept åªæ˜¯ä»å»ºç«‹å¥½çš„è¿æ¥é‡Œå–å‡ºä¸€ä¸ªæ¥ï¼Œè€ŒåŒæ—¶ç­‰å¾… accept å¤„ç†çš„è¿æ¥æ•°å—åˆ°ç³»ç»Ÿçš„é™åˆ¶ï¼Œåœ¨ mac æ˜¯ä¸Šå®ƒçš„å€¼æ˜¯ kern.ipc.somaxconnï¼Œé»˜è®¤æ˜¯ 128 ä¸ªï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯æ²¡æœ‰è¢« accept çš„è¿æ¥æ•°æœ€å¤§æ˜¯ 128 ä¸ªï¼Œæ‰€ä»¥ä¸€å¼€å§‹ server ç«¯å¾ˆå¿«æ”¶åˆ°äº† client å®¢æˆ·ç«¯çš„ 128 ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯ dial å‡ ä¹ç«‹å³æˆåŠŸï¼Œä½†æ˜¯ server ç«¯æ¯éš” 5 ç§’åæ‰ accept å–å‡ºæ¥ä¸€ä¸ªè¿æ¥è¿›è¡Œå¤„ç†ï¼Œå¤„ç†ä¸€ä¸ªåæ‰æœ‰ä¸€ä¸ªå‘ä½æŒªå‡ºæ¥ï¼Œæ‰€ä»¥è¾¾åˆ° kern.ipc.somaxconn çš„é™åˆ¶å client éœ€è¦éš”ä¸Š 5 ç§’æ‰èƒ½æˆåŠŸå»ºç«‹è¿æ¥ã€‚

å¦‚æœæœåŠ¡ç«¯ä¸€ç›´æ²¡æœ‰å‘ä½ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ dial ä¼šå‘ç”Ÿè¶…æ—¶é”™è¯¯ã€‚

```go
func startTcpServer3() {
  listener, _ := net.Listen("tcp", "127.0.0.1:3000")
  defer listener.Close()
  select {}
}

func startTcpClient3() {
  for i := 0; i < 1024; i++ {
    _, err := net.Dial("tcp", "127.0.0.1:3000")
    // è®¾ç½®è¶…æ—¶æ—¶é—´
    //_, err := net.DialTimeout("tcp", "127.0.0.1:3000", 1*time.Second)
    if err != nil {
      fmt.Println(err)
    } else {
      fmt.Println("dial at " + time.Now().Format("2006-01-02 15:04:05"))
    }
  }
}
```

æ§åˆ¶è¶…æ—¶çš„ç­‰å¾…æ—¶é—´å¯ä»¥ä½¿ç”¨ net.DialTimeout å‡½æ•°ï¼Œæ²¡æœ‰å‘ä½çš„æ—¶å€™ dial å¼€å§‹æŠ¥è¶…æ—¶é”™äº†:

```go
......
dial at 2021-01-10 14:47:04
dial at 2021-01-10 14:47:04
dial at 2021-01-10 14:47:04
dial tcp 127.0.0.1:3000: i/o timeout
dial tcp 127.0.0.1:3000: i/o timeout
dial tcp 127.0.0.1:3000: i/o timeout
......
```


åŒæ ·çš„è¯»å†™ä¹Ÿä¼šæœ‰æ—¶é—´è¶…æ—¶çš„é—®é¢˜ï¼Œè¯»å†™è¶…æ—¶çš„æ—¶é—´ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°è®¾ç½®:  
1. SetDeadline(t time.Time)  
2. SetReadDeadline(t time.Time)  
3. SetWriteDeadline(t time.Time)  

å‚æ•°æ˜¯ä¸€ä¸ª time.Time ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä»è¿æ¥è¢« accept åˆ°æ•°æ®è¢«å®Œå…¨è¯»å–å¿…é¡»åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å†…ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå‡†ç¡®çš„æ—¶é—´ç‚¹ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡è¯»å†™ä¹‹å‰éƒ½éœ€è¦ä¸ºå…¶è®¾ç½®æ–°çš„æ—¶é—´ç‚¹ã€‚çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­:

```go
func startServerWithTimeout() {
  listener, _ := net.Listen("tcp", "127.0.0.1:3000")
  defer listener.Close()
  for {
    conn, _ := listener.Accept()
    conn.SetDeadline(time.Now().Add(3 * time.Second))
    c := &client{conn, 3}
    go handle(c)
  }
}
```

æ¥å—è¿æ¥åè®¾ç½®è¯»å†™è¶…æ—¶çš„æ—¶é—´æ˜¯ 3 ç§’é’Ÿï¼Œçœ‹çœ‹ handle å‡½æ•°çš„å¤„ç†:

```go
type client struct {
  conn    net.Conn
  timeout int
}

func handle(c *client) {
  buf := make([]byte, 100)
  for {
    size, err := c.conn.Read(buf)
    if err != nil || size == 0 {
      fmt.Println(err)
      c.conn.Close()
      return
    }

    c.conn.SetDeadline(time.Now().Add(3 * time.Second))
    fmt.Println(string(buf))
  }
}
```

å¦‚æœè¯»æˆåŠŸäº†ï¼Œå°±ç»§ç»­ç»­å‘½ 3 ç§’ï¼Œå¦‚æœéƒ½å¤±è´¥äº†ï¼Œå°±æŠŠé“¾æ¥å…³é—­äº†ã€‚å¯åŠ¨åç”¨ telnet è¿æ¥ï¼Œå¦‚æœ 3 ç§’é’Ÿè¾“å…¥ä»»ä½•å­—ç¬¦å›è½¦å‘é€ç»™ server ç«¯ï¼Œé‚£ä¹ˆè¿æ¥å¯ä»¥ä¸€ç›´å­˜æ´»ä¸‹å»ï¼Œå¦‚æœ 3 ç§’å†…æ— æ•°æ®ï¼ŒæœåŠ¡ç«¯æ˜¾ç¤º i/o timeout ç„¶åè¿æ¥è¢«å¼ºè¡Œå…³é—­ã€‚ä¿®æ”¹ä¸€ä¸‹ç¨‹åºï¼Œä½¿ç”¨é€šé“æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œé¦–å…ˆä¸º client  å¯¹è±¡å¢åŠ ä¸€ä¸ªé€šé“æˆå‘˜ç”¨äºé€šè®¯:

```go
type client struct {
  conn       net.Conn
  activeChan chan struct{}
  timeout    int
}
```

åœ¨ handle æ¯æ¬¡è¯»æˆåŠŸåéƒ½ç»™é€šé“å‘é€ä¸€ä¸ªä¿¡å·:

```go
func handle(c *client) {
  for {
    buf := make([]byte, 100)
    size, err := c.conn.Read(buf)
    if err == nil || size > 0 {
      c.activeChan <- struct{}{}
      fmt.Println(string(buf))
    }
  }
}
```

å¢åŠ ä¸€ä¸ª goroutine ä¸“é—¨ç”¨äºæ£€æµ‹æ˜¯å¦æ”¶åˆ°äº†ä¿¡å·ï¼Œåœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰ä¿¡å·ï¼Œåˆ™ä¸»åŠ¨å…³é—­è¿æ¥:

```go
func alive(c *client) {
  for {
    select {
    case <-c.activeChan:
      fmt.Println("keep alive")
    case <-time.After(time.Duration(c.timeout) * time.Second):
      c.conn.Write([]byte("goodbye\n"))
      c.conn.Close()
    }
  }
}
```

å¯åŠ¨æœåŠ¡å™¨çš„ä»£ç å¦‚ä¸‹ï¼Œæ¯æ¬¡ accept æ—¶ï¼Œå¯åŠ¨ 2 ä¸ª goroutine æ¥æœåŠ¡ä¸€ä¸ªå®¢æˆ·ç«¯:

```go
func startServerWithTimeout() {
  listener, _ := net.Listen("tcp", "127.0.0.1:3000")
  defer listener.Close()
  for {
    conn, _ := listener.Accept()
    c := &client{conn, make(chan struct{}), 3}
    go handle(c)
    go alive(c)
  }
}
```

ä½¿ç”¨ telnet æµ‹è¯•ï¼Œ3 ç§’å†…è¾“å…¥ä»»æ„å­—ç¬¦éƒ½å¯ç»­å‘½ï¼Œå¦åˆ™è¶…æ—¶è¢«å…³é—­ï¼Œåœ¨ alive ä¸­å…¶å®å¯ä»¥åšå¾ˆå¤šéœ€è¦æˆåŠŸè¯»å–åè¦å¤„ç†çš„ä¸šåŠ¡ï¼Œé€šé“çš„ä½œç”¨å…¶å®æŠŠè¿æ¥è¯»å†™çš„ç»†èŠ‚ã€ä¸šåŠ¡å¤„ç†ã€è¿æ¥çŠ¶æ€ç»´æŠ¤è§£è€¦äº†ï¼Œè¿™ä¸ªæ¨¡å¼å¾ˆæœ‰ç”¨ï¼Œåœ¨ go ç½‘ç»œç¼–ç¨‹ä¸­å¾ˆå¸¸è§ã€‚

tcp æ˜¯é¢å‘è¿æ¥çš„é€šè®¯ï¼Œé€‚ç”¨äºå¯¹æ•°æ®ä¼ è¾“è¦æ±‚éå¸¸é«˜çš„åœºæ™¯ï¼Œä½†æ˜¯æœ‰äº›ä¸šåŠ¡æ¯”å¦‚èŠå¤©ã€è§†é¢‘å¯ä»¥å¿½ç•¥å¶å°”çš„ä¼ è¾“é”™è¯¯ï¼Œè¿™æ—¶å€™ä½¿ç”¨ udp åè®®æ›´ä¸ºåˆé€‚ï¼Œå®ƒå®šä¹‰äº†æ— éœ€è¿æ¥å°±å¯ä»¥å‘é€ IP æ•°æ®åŒ…çš„æ–¹æ³•ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥å‘ä»»æ„çš„ä¸åŒçš„æœåŠ¡å™¨å‘é€æ•°æ®ã€‚

å®šä¹‰ä¸€ä¸ª udp server å¦‚ä¸‹:

```go
func startUdpServer() {
  listener, _ := net.ListenUDP("udp", &net.UDPAddr{IP: net.ParseIP("127.0.0.1"), Port: 3000})
  buf := make([]byte, 100)
  for {
    size, remoteAddr, err := listener.ReadFromUDP(buf)
    if err == nil && size > 0 {
      fmt.Println(remoteAddr.String())
      fmt.Println(string(buf))
    }
  }
}
```

ç”±äºæ²¡æœ‰äº‹å‰å»ºç«‹è¿æ¥ï¼Œudp å®¢æˆ·ç«¯åœ¨å‘é€æ•°æ®çš„æ—¶å€™éœ€è¦æŒ‡æ˜æœ¬æœºçš„åœ°å€å’Œè¿œç«¯çš„åœ°å€:

```go
func startUdpClient() {
  ip := net.ParseIP("127.0.0.1")
  // è‡ªåŠ¨åˆ†é…
  // local := &net.UDPAddr{IP: net.IPv4zero, Port: 1110}
  local := &net.UDPAddr{IP: ip, Port: 3001}
  remote := &net.UDPAddr{IP: ip, Port: 3000}
  conn, _ := net.DialUDP("udp", local, remote)
  defer conn.Close()
  conn.Write([]byte("can you hear me?\n"))
}
```

åˆ›å»ºä¸€ä¸ª http åº”ç”¨æœåŠ¡å™¨åˆ™æ¯” tcp å’Œ udp æ›´åŠ ç®€å•ï¼Œæ¯•ç«Ÿå®ƒæ˜¯æœ€ä¸Šå±‚çš„ä¸€ä¸ªå°è£…:

```go
func startHttpServer() {
  http.HandleFunc("/time", func(writer http.ResponseWriter, request *http.Request) {
    writer.Write([]byte(time.Now().String()))
  })

  http.HandleFunc("/headers", func(writer http.ResponseWriter, request *http.Request) {
    for key, headers := range request.Header {
      for _, val := range headers {
        fmt.Fprintf(writer, "%v:%v\n", key, val)
      }
    }
  })

  http.ListenAndServe(":3000", nil)
}
```

è¯·æ±‚çš„å¯¹è±¡è¢«æŠ½è±¡æˆ http.Requestï¼Œå“åº”å¯¹è±¡è¢«æŠ½è±¡ä¸º http.ResponseWriterï¼Œ2 ä¸ªè·¯ç”±:  
1. /time æ‰“å°å½“å‰æœåŠ¡å™¨æ—¶é—´  
2. /headers æ‰“å°è¯·æ±‚çš„ http å¤´  

ä¸‹é¢æ˜¯ http.ListenAndServe çš„å®ç°:

```go
func ListenAndServe(addr string, handler Handler) error {
  server := &Server{Addr: addr, Handler: handler}
  return server.ListenAndServe()
}
```

å®šä¹‰äº†ä¸€ä¸ª http.Server ç»“æ„ä½“ï¼Œè°ƒç”¨å®ƒçš„åŒåæ–¹æ³•ï¼Œå®ç°å¦‚ä¸‹:

```go
func (srv *Server) ListenAndServe() error {
  if srv.shuttingDown() {
    return ErrServerClosed
  }
  addr := srv.Addr
  if addr == "" {
    addr = ":http"
  }
  ln, err := net.Listen("tcp", addr)
  if err != nil {
    return err
  }
  return srv.Serve(ln)
}
```

æœ¬è´¨è¿˜æ˜¯å¯åŠ¨ä¸€ä¸ª tcp æœåŠ¡å™¨ï¼Œå¤§é‡çš„å·¥ä½œéƒ½æ˜¯åœ¨å¤„ç† http åè®®å¤´å’Œå¯¹å®¢æˆ·ç«¯å“åº”æ•°æ®(http.Request å¯¹è±¡æ¯” http.ResponseWriter å¯¹è±¡å¤æ‚çš„å¤š)ï¼Œæ ¹æ®è¿™ä¸ªåŸç†ï¼Œä½ å¯ä»¥å®ç°ä¸€ä¸ªè‡ªå·±çš„ http æœåŠ¡å™¨ã€‚


æœ¬ç« èŠ‚çš„ä»£ç  [https://github.com/developdeveloper/go-demo/tree/master/17-network-socket](https://github.com/developdeveloper/go-demo/tree/master/17-network-socket)
