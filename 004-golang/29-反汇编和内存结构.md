ä½¿ç”¨ go tool compile -S main.go å¯ä»¥æ˜¾ç¤ºå‡º go æ±‡ç¼–çš„ä»£ç (æˆ– go build -gcflags -S main.go)ï¼Œgo æ±‡ç¼–åŸºäº plan 9ï¼Œå’Œç³»ç»Ÿåº•å±‚çš„æ±‡ç¼–ä»£ç æœ‰æ‰€åŒºåˆ«ï¼Œ ä½†æ˜¯åšåˆ°äº†è·¨å¹³å°æ±‡ç¼–ä¸å…·ä½“çš„ç³»ç»Ÿæ¶æ„æ— å…³ã€‚å¾ˆå¤šäººéƒ½åæ§½ä¸ºä»€ä¹ˆæ˜¯ plan 9? plan 9 æ˜¯ 1980 å¹´ä»£ä¸­æœŸçš„ä¸€ä¸ªåˆ†å¸ƒå¼æ“ä½œç³»ç»Ÿï¼Œè¢«ç§°ä¸ºè´å°”å®éªŒå®¤ 9 å·é¡¹ç›®ï¼Œä½œä¸º UNIX çš„åç»§ï¼Œç°åœ¨ä»»ç„¶è¢«çˆ±å¥½è€…ç ”ç©¶å’Œä½¿ç”¨ã€‚

main.go çš„æºä»£ç å’Œå¯¹åº”çš„ go æ±‡ç¼–ä»£ç :

```go
package main

import (
  "runtime"
)

func main() {
  println(runtime.GOOS)
}
```

![](https://develop-developer.oss-cn-hangzhou.aliyuncs.com/images/WdcSRi25nne7FfQgF-uZ6bS_vMtFTF4Ageh8L-KbRY.png?x-oss-process=style/txt-water)

å…ˆå¿½ç•¥æ‰ PCDATA å’Œ FUNCDATAï¼Œå®ƒä»¬æ˜¯ç»™ GC åƒåœ¾æ”¶é›†å™¨æä¾›é™„åŠ ä¿¡æ¯çš„æŒ‡ä»¤ã€‚æ‰§è¡Œ go build æŠŠå®ƒç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨ go tool objdump å°±èƒ½çœ‹åˆ°ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„æ±‡ç¼–ä»£ç ï¼Œæˆ‘ç›®å‰çš„ç³»ç»Ÿæ˜¯ darwin intel i7:

```
# go build -o main main.go 
# go tool objdump -s main.main main
```

äºŒè¿›åˆ¶æ±‡ç¼–ä»£ç çš„ç»“æœ:

![](https://develop-developer.oss-cn-hangzhou.aliyuncs.com/images/GTg47u49QprXiLPsi-L1sI2GljDTChxOBeKldYys51.png?x-oss-process=style/txt-water)

å®˜ç½‘æœ‰ä¸€ä¸ªæ±‡ç¼–å…¥é—¨çš„æ•™ç¨‹ https://golang.org/doc/asmï¼Œ æ³¨æ„ go æ±‡ç¼–æ˜¯åŸºäº package çš„ï¼Œä»æœ€ç®€å•çš„å¼€å§‹ï¼Œé¦–å…ˆçœ‹çœ‹å¦‚ä½•å®šä¹‰åŒ…çš„å¯¼å‡ºå˜é‡:

```asm
// id.go
package vardef

var ID= 9927

// str.go
package vardef

var Str = "hello"
```

å› ä¸ºä¸æ¶‰åŠåˆ°ä»»ä½•å‡½æ•°è°ƒç”¨ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶äº§ç”Ÿçš„ä¼ªæ±‡ç¼–ä»£ç æ¯”è¾ƒç®€å•:

```asm
// id.go
vardef[master*] ğŸ go tool compile -S id.go     
go.cuinfo.packagename. SDWARFINFO dupok size=0
	0x0000 76 61 72 64 65 66                                vardef
"".ID SNOPTRDATA size=8
	0x0000 c7 26 00 00 00 00 00 00                          .&......

// str.go
vardef[master*] ğŸ go tool compile -S str.go
go.cuinfo.packagename. SDWARFINFO dupok size=0
	0x0000 76 61 72 64 65 66                                vardef
go.string."hello" SRODATA dupok size=5
	0x0000 68 65 6c 6c 6f                                   hello
"".Str SDATA size=16
	0x0000 00 00 00 00 00 00 00 00 05 00 00 00 00 00 00 00  ................
	rel 0+8 t=1 go.string."hello"+0
```

ç¬¬ä¸€ä¸ªç¨‹åº id.go å®šä¹‰äº†ä¸€ä¸ªæ•´æ•°ï¼Œç¬¬äºŒä¸ª str.go å®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨ go çš„ asm æ–‡æ¡£ä¸­æ‰¾åˆ°æ•°æ®çš„å®šä¹‰ç»“æ„:

```asm
DATA	symbol+offset(SB)/width, value
GLOBL   symbol(SB), width
GLOBL   symbol(SB), RODATA, width // åªè¯»
```

1. symbol æ˜¯æ ‡è¯†ç¬¦ï¼Œ.symbol æ˜¯å½“å‰åŒ…ï¼Œæ¯”å¦‚ .IDã€.Str

2. offset æ˜¯åˆå§‹åœ°å€çš„åç§»é‡

3. value æ˜¯å€¼, width æ˜¯å†…å­˜å®½åº¦ï¼Œwidth å¿…é¡»æ˜¯ 1ã€2ã€4ã€8ã€16 ç­‰

é™¤äº† DATAï¼Œè¿˜æœ‰ TEXT å®šä¹‰å‡½æ•°ã€GLOBL å¯¼å‡ºå…¨å±€å˜é‡ï¼ŒSRODATA è¡¨ç¤ºæ•°æ®åœ¨å†…å­˜åªè¯»ï¼Œå› ä¸º go å­—ç¬¦ä¸²æœ¬è´¨æ˜¯ä¸€ç§åªè¯»çš„å¼•ç”¨ç±»å‹ï¼Œdupok è¡¨ç¤ºåªæœ‰ä¸€ä»½ï¼Œå®ƒå®Œæ•´çš„å¼•ç”¨ç¬¦å·æ˜¯ go.string."hello"ï¼Œå¦‚æœå†å‡ºç°å¯¹ hello çš„å¼•ç”¨ï¼Œå°±å¯ä»¥è¿æ¥ go.string."hello" è¿™ä¸ªç¬¦å·ä¸Šï¼Œåé¢çš„ .Str å°±å¼•ç”¨äº†è¿™ä¸ª hello ç¬¦å·ï¼Œè€Œä¸” "".Str çš„ size=16ï¼Œè¡¨ç¤ºå ç”¨ 16 ä¸ªå­—èŠ‚ï¼Œä¸ºä»€ä¹ˆå‘¢? å› ä¸ºå‰é¢ç« èŠ‚è®²è¿‡ StringHeader çš„å®šä¹‰æ˜¯:

```go
type reflect.StringHeader struct {
  Data uintptr
  Len int 
}
```

Data å­—æ®µæ˜¯æŒ‡å‘ go.string."hello" çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå¤§å°æ˜¯ 8 ä¸ªå­—èŠ‚ï¼ŒLen è¡¨ç¤ºæœ‰æ•ˆæ•°æ®çš„é•¿åº¦ï¼Œä¹Ÿå  8 ä¸ªå­—èŠ‚ï¼Œè·³è¿‡å¼•ç”¨åœ°å€çš„ 0x0000 8 ä¸ªå­—èŠ‚åæ˜¯ 05ï¼Œå› ä¸º hello çš„é•¿åº¦æ˜¯ 5 ä¸ªå­—èŠ‚ã€‚ç›¸å¯¹äº SDATAï¼Œå®šä¹‰ "".ID çš„ SNOPTRDATA è¡¨ç¤ºä¸åŒ…å«æŒ‡é’ˆã€‚

åœ¨ç»§ç»­å‡½æ•°ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ plan 9 æ±‡ç¼–æŒ‡ä»¤å’Œå¯„å­˜å™¨ã€‚plan 9 æ²¡æœ‰ intel çš„ pushã€pop æŒ‡ä»¤ï¼Œä¾é  SP çš„åŠ å‡æ“ä½œæ¥æ“ä½œå‡½æ•°æ ˆå¸§ï¼Œgo çš„ä¼ªå¯„å­˜å™¨ã€é€šç”¨å¯„å­˜å™¨ã€æŒ‡ä»¤å’Œæ“ä½œæ•°åŸºæœ¬çš„è§„åˆ™:

1. ä¼ªå¯„å­˜å™¨ SP å±€éƒ¨å˜é‡çš„åº•éƒ¨(æ ˆæ–¹å‘é«˜å¤§åˆ°ä½ï¼Œä¹Ÿæ˜¯å½“å‰æ ˆçš„ BP åŸºåœ°å€ï¼Œå¾€æ ˆåº•æ–¹å‘æ˜¯è°ƒç”¨è€… ret è¿”å›åœ°å€)ï¼ŒSP - 8 æ˜¯å€’æ•°ç¬¬ä¸€ä¸ª int æœ¬åœ°å˜é‡ï¼ŒSP -16 å€’æ•°ç¬¬äºŒä¸ª(æ³¨æ„æ ˆçš„å¢é•¿æ–¹å‘æ˜¯é«˜åœ°å€å‘ä½åœ°å€æ‰©å¼ )ï¼ŒSP å¢é•¿æ–¹å‘å°±æ˜¯è¿”å›åœ°å€å’Œè°ƒç”¨è€…å‚æ•°äº†

2. ä¼ªå¯„å­˜å™¨ SP åªæœ‰åœ¨æ‰‹å†™ä¼šç¼–æ˜¯ç”¨åˆ°ï¼Œå®ƒæŒ‡å‘å½“å‰å‡½æ•°æ ˆçš„æ ˆé¡¶ä½ç½®ï¼Œæ‰‹å†™æ±‡ç¼–ä½¿ç”¨ä¼ªå¯„å­˜å™¨å‰é¢è¦å¸¦ symbolï¼Œå¦åˆ™æ˜¯è°ƒç”¨ç¡¬ä»¶å¯„å­˜å™¨ï¼Œåç¼–è¯‘åçš„ SP éƒ½æ˜¯ç¡¬ä»¶ SPï¼Œæ— è®ºå‰é¢å¸¦ä¸å¸¦ symbolï¼Œè¦ç‰¹åˆ«æ³¨æ„

3. ä¼ªå¯„å­˜å™¨ FP æ ‡è¯†å‡½æ•°å‚æ•°ã€è¿”å›å€¼ï¼Œç›´æ¥ FP + 0 æ˜¯ç¬¬ä¸€ä¸ªè°ƒç”¨å‚æ•°ï¼ŒFP +8 ç¬¬äºŒä¸ªè°ƒç”¨å‚æ•°

4. PC å°±æ˜¯ x86 çš„ IP å¯„å­˜å™¨ï¼ŒEB ä¾ç„¶æ˜¯åŸºå€å¯„å­˜å™¨ï¼Œç°ä»£ç¼–è¯‘å™¨ä¸­ EB ä¸æ˜¯å¿…é¡»çš„ä½†å¯¹è°ƒè¯•æœ‰å¸®åŠ©

5. ä¼ªå¯„å­˜å™¨ SB å…¨å±€é™æ€åŸºåœ°å€ï¼Œç”¨æ¥ç”³æ˜å‡½æ•°å’Œå…¨å±€å˜é‡

6. é€šç”¨å¯„å­˜å™¨ raxã€rbxã€rcx ç­‰ï¼Œæ“ä½œçš„æ—¶å€™ r å¯ä»¥ä¸å†™ï¼Œå’Œ Intel X86-64 ä¸ä¸€æ · (çœ‹ç¬¬10æ¡)

7. å¸¸æ•°ä½¿ç”¨ $num è¡¨ç¤ºï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ $0x è¡¨ç¤º16 è¿›åˆ¶æ•°ï¼Œå¯ä»¥æ˜¯ç”¨-è¡¨ç¤ºè´Ÿæ•°

8. æ“ä½œæ•°çš„æ–¹å‘å’Œ intel X86-64 æ˜¯ç›¸åçš„ï¼ŒJMP è·³è½¬åŒä¸€å‡½æ•°å†…å¯ä»¥ä½¿ç”¨ labelï¼Œä¼šè¢«è½¬æ¢æˆç›¸å¯¹è·³è½¬

9. å’Œ Intel x86-64 ä¸€æ ·ï¼Œ(Reg) å¼•ç”¨å¯„å­˜å™¨çš„å€¼æ‰€å¯¹åº”å†…å­˜ä¸­çš„æ•°æ®ï¼Œæ²¡æœ‰å†…å­˜ to å†…å­˜çš„æŒ‡ä»¤ï¼Œå¿…é¡»é€šè¿‡å¯„å­˜å™¨ä¸­è½¬

10. æŒ‡ä»¤å†³å®šæ“ä½œæ•°å°ºå¯¸ XXXB = 1 XXXW = 2 XXXD = 4 XXXQ = 8ï¼Œè€Œ Intel ç”±æ“ä½œçš„å¯„å­˜å™¨å†³å®š AL/AH = 1ã€AX = 2ã€EAX = 4ã€RAX = 8

![](http://processon.com/chart_image/600fdffa5653bb20cedbbe3e.png)

æ±‡ç¼–æ“ä½œæŒ‡ä»¤çš„æ ·ä¾‹:

```asm
SUBQ $0x18, SP   // åˆ†é…å‡½æ•°æ ˆï¼Œæ“ä½œæ•° 8 ä¸ªå­—èŠ‚
ADDQ $0x18, SP   // æ¸…é™¤å‡½æ•°æ ˆï¼Œæ“ä½œæ•° 8 ä¸ªå­—èŠ‚
MOVB $1, DI      // æ‹·è´ 1ä¸ªå­—èŠ‚
MOVW $0x10, BX   // æ‹·è´ 2 ä¸ªå­—èŠ‚
MOVD $1, DX      // æ‹·è´ 4 ä¸ªå­—èŠ‚
MOVQ $-10, AX    // æ‹·è´ 8 ä¸ªå­—èŠ‚
ADDQ AX, BX      // BX = BX + AX å­˜ BX
SUBQ AX, BX      // BX = BX - AX å­˜ BX
IMULQ AX, BX     // BX = BX * AX å­˜ BX
MOVQ AX, BX      // BX = AX å°† AX ä¸­çš„å€¼èµ‹ç»™ BX
MOVQ (AX), BX    // BX = *AX åŠ è½½ AX ä¸­æŒ‡å‘å†…å­˜åœ°å€çš„å€¼ç»™ BX
MOVQ 16(AX), BX  // BX = *(AX + 16) åç§» 16 ä¸ªå­—èŠ‚ååœ°å€ä¸­çš„å€¼
```

ç¼–å†™ä¸€ä¸ªåŠ æ³•çš„å‡½æ•°ï¼Œgo tool compile -S ç»“æœå¦‚ä¸‹:

```go
// func.go
package funcasm

func add(a, b int) int {
  return a + b
}

"".add STEXT nosplit size=19 args=0x18 locals=0x0
  0x0000 00000 (func.go:3)	TEXT	"".add(SB), NOSPLIT|ABIInternal, $0-24
  ...
  0x0000 00000 (func.go:4)	MOVQ	"".b+16(SP), AX
  0x0005 00005 (func.go:4)	MOVQ	"".a+8(SP), CX
  0x000a 00010 (func.go:4)	ADDQ	CX, AX
  0x000d 00013 (func.go:4)	MOVQ	AX, "".~r2+24(SP)
  0x0012 00018 (func.go:4)	RET
```

SB æ˜¯ç¨‹åºåœ°å€ç©ºé—´å¼€å§‹çš„åŸºåœ°å€ï¼Œå¼•ç”¨å‡½æ•°çš„è¾“å…¥å‚æ•°è¡¨ç¤ºå½¢å¼ "".a+8(SP)ï¼Œ"".b+16(SP)ï¼Œå› ä¸ºç¡¬ä»¶ SP æŒ‡å‘å‡½æ•°æ ˆæ ˆé¡¶åœ°å€ã€‚

![](http://processon.com/chart_image/600fde0b63768934903b0665.png)

$0-24 è¡¨ç¤ºå‡½æ•°æ ˆå¸§å¤§å°æ˜¯ 0ï¼Œå‚æ•°å’Œè¿”å›å€¼ä¸€å…±éœ€è¦ 24 ä¸ªå­—èŠ‚(3 ä¸ª int)ï¼Œ~r2+24(SP) æ˜¯è¿”å›å€¼çš„åœ°å€ï¼Œ RET æ¸…é™¤å‡½æ•°æ ˆï¼Œå¼¹å‡ºæ ˆé¡¶çš„è¿”å›åœ°å€åˆ°  IP å¯„å­˜å™¨ï¼Œä»è°ƒç”¨ add çš„ä¸‹ä¸€è¡Œå¼€å§‹æ‰§è¡Œã€‚å¦å¤– NOSPLIT çš„æ„æ€ä¸æ’å…¥æ£€æŸ¥æ ˆæ‰©å¼ çš„æŒ‡ä»¤(å› ä¸ºæ ˆå¸§å¤§å°æ˜¯ 0 æ²¡å¿…è¦æ£€æŸ¥)ï¼Œå®ƒå¯¹åº” go çš„ç¼–è¯‘æŒ‡ç¤º //go:nosplitã€‚æ ˆè°ƒç”¨çš„ä¸€èˆ¬æ€§ç»“æ„å¦‚ä¸‹:

![](http://processon.com/chart_image/600e86b2e401fd0a1f89741e.png)

ä¿®æ”¹ä¸€ä¸‹ func.goï¼Œåˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œè§‚å¯Ÿæ ˆå¸§çš„å¤§å°å˜åŒ–:

```go
// func2.go 
package main

func add2(a, b int) int {
  times := 2
  println(times)
  return (a - b) * times
}

// func2.o
"".add2 STEXT size=103 args=0x18 locals=0x10
  0x0000 00000 (func2.go:3)	TEXT	"".add2(SB), ABIInternal, $16-24
  0x0000 00000 (func2.go:3)	MOVQ	(TLS), CX   // * thread local storage 
  0x0009 00009 (func2.go:3)	CMPQ	SP, 16(CX)  // *
  0x000d 00013 (func2.go:3)	PCDATA	$0, $-2     
  0x000d 00013 (func2.go:3)	JLS	96          // *
  0x000f 00015 (func2.go:3)	PCDATA	$0, $-1
  0x000f 00015 (func2.go:3)	SUBQ	$16, SP     // # æ ˆç©ºé—´
  0x0013 00019 (func2.go:3)	MOVQ	BP, 8(SP)   // # è€çš„åŸºå€(ä¿å­˜ BP å¯„å­˜å™¨çš„å€¼åˆ°å†…å­˜åœ°å€ 8(SP))
  0x0018 00024 (func2.go:3)	LEAQ	8(SP), BP   // # æ–°çš„åŸºå€(æ‹·è´ 8(SP) çš„å†…å­˜å¼•ç”¨åœ°å€å€¼åˆ° BP)
  ...
  0x001d 00029 (func2.go:5)	NOP
  0x0020 00032 (func2.go:5)	CALL	runtime.printlock(SB)
  0x0025 00037 (func2.go:5)	MOVQ	$2, (SP)
  0x002d 00045 (func2.go:5)	CALL	runtime.printint(SB)
  0x0032 00050 (func2.go:5)	CALL	runtime.printnl(SB)
  0x0037 00055 (func2.go:5)	CALL	runtime.printunlock(SB)
  0x003c 00060 (func2.go:6)	MOVQ	"".a+24(SP), AX
  0x0041 00065 (func2.go:6)	MOVQ	"".b+32(SP), CX
  0x0046 00070 (func2.go:6)	SUBQ	CX, AX
  0x0049 00073 (func2.go:6)	SHLQ	$1, AX                      // * å·¦ç§»
  0x004c 00076 (func2.go:6)	MOVQ	AX, "".~r2+40(SP)
  0x0051 00081 (func2.go:6)	MOVQ	8(SP), BP
  0x0056 00086 (func2.go:6)	ADDQ	$16, SP
  0x005a 00090 (func2.go:6)	RET
  0x005b 00091 (func2.go:6)	NOP                                  
  0x005b 00091 (func2.go:3)	PCDATA	$1, $-1
  0x005b 00091 (func2.go:3)	PCDATA	$0, $-2
  0x005b 00091 (func2.go:3)	NOP                                  
  0x0060 00096 (func2.go:3)	CALL	runtime.morestack_noctxt(SB) // * æ‰©å®¹
  0x0065 00101 (func2.go:3)	PCDATA	$0, $-1                      
  0x0065 00101 (func2.go:3)	JMP	0 
```

åŒ…å«ä¸€ä¸ªå±€éƒ¨å˜é‡ timesï¼Œadd å‡½æ•°çš„æ ˆå¸§å¤§å°æ˜¯ 16 å­—èŠ‚ã€‚æ³¨æ„ // * æ ‡è®°çš„æ˜¯ç¼–è¯‘å™¨æ’å…¥çš„ç”¨äºæ£€æŸ¥æ ˆç©ºé—´çš„ä»£ç ï¼Œadd2 å’Œ add ä¸åŒçš„è¿˜æœ‰ # æ ‡è®°çš„ä»£ç ï¼Œå› ä¸º add2 è¿˜è¦è°ƒç”¨ println å‡½æ•°ï¼Œåœ¨ println å‡½æ•°è¿”å›çš„æ—¶å€™è¿˜éœ€è¦æ¢å¤è°ƒç”¨ add çš„æ—¶å€™çš„ BP åŸºåœ°å€ï¼Œæ‰€ä»¥éœ€è¦ä¿å­˜è€çš„ BP åœ°å€ï¼Œå‚æ•°å’Œè¿”å›å€¼ä¾ç„¶ 24 ä¸ªå­—èŠ‚ï¼Œæ³¨æ„ LEAQ æŒ‡ä»¤æ˜¯å¼•ç”¨å¯„å­˜å™¨æŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œä¸æ˜¯åŠ è½½å®ƒæŒ‡å‘çš„å€¼(ç†è§£ä¸º & å–åœ°å€ç¬¦)ã€‚

![](http://processon.com/chart_image/6010dd8de0b34d1f2cca86a2.png)


æ‰‹å†™æ±‡ç¼–ä»£ç çš„æ—¶å€™ï¼Œä¸éœ€è¦è€ƒè™‘ CALL å’Œ RET æŒ‡ä»¤å¯¹ PC å¯„å­˜å™¨çš„æ“ä½œå½±å“ï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘ PC å¯„å­˜å™¨æ’å…¥çš„ 8 å­—èŠ‚è¿”å›åœ°å€å ç”¨çš„æ ˆç©ºé—´ï¼Œä»¿é€ æ±‡ç¼–çš„ä»£ç ï¼Œå†™ä¸€ä¸ª add.s æ±‡ç¼–æ¨¡å—:

```asm
// add.s
#include "textflag.h"

TEXT Â·add(SB), NOSPLIT, $0-24
  MOVQ b+16(SP), AX       // MOVQ b+8(FP), AX
  MOVQ a+8(SP), BX        // MOVQ a+0(FP), BX
  ADDQ BX, AX
  MOVQ AX, ret + 24(SP)   // MOVQ AX, ret + 16(FP)
  RET

// main.go 
package main

func add(a, b int) int

func main() {
  println(add(1, 2))
}
```

åœ¨ä¸ªä¾‹å­çš„æ ˆå¸§ä¸º 0 æ¯”è¾ƒç‰¹æ®Šï¼Œä¹Ÿæ— æœ¬åœ°å±€éƒ¨å˜é‡å’Œè°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œä¸éœ€è¦ä¿å­˜ BP åŸºåœ°å€ï¼Œåªéœ€è¦è·¨è¿‡è¿”å›åœ°å€çš„ 8 å­—èŠ‚å°±è¡Œäº†ã€‚

![](http://processon.com/chart_image/6010f432079129652cd7b215.png)

å½“ç„¶ç”¨  FP æ˜¾å¾—æ›´åŠ ç›´è§‚ä¸€äº›ï¼Œè¾“å…¥ go run . è¿è¡Œæ˜¾ç¤º:

```
callasmfunc[master*] ğŸ go run .
3
```


ç¼–å†™ä¸€ä¸ªè¿”å›å¤šä¸ªå€¼çš„å‡½æ•°:

```go
package main

//go:noinline
func swap(a, b int) (int, int) {
  return b+1, a+1
}

func main() {
  _ = swap(0, 1)
}
```

//go:noinline è¡¨ç¤ºä¸è¦å†…è”å‡½æ•°ï¼Œswap å‡½æ•°çš„æ±‡ç¼–ä»£ç :

```asm
"".swap STEXT nosplit size=27 args=0x20 locals=0x0
  0x0000 00000 (main.go:4)	TEXT	"".swap(SB), NOSPLIT|ABIInternal, $0-32
  ...
  0x0000 00000 (main.go:5)	MOVQ	"".b+16(SP), AX
  0x0005 00005 (main.go:5)	INCQ	AX
  0x0008 00008 (main.go:5)	MOVQ	AX, "".~r2+24(SP) // *
  0x000d 00013 (main.go:5)	MOVQ	"".a+8(SP), AX
  0x0012 00018 (main.go:5)	INCQ	AX
  0x0015 00021 (main.go:5)	MOVQ	AX, "".~r3+32(SP) // *
  0x001a 00026 (main.go:5)	RET
```

å‚æ•° 2 ä¸ªå’Œè¿”å›å€¼ 2 ä¸ªï¼Œå…± $0-32 æ ˆå¸§å¤§å°ä¸º 0ï¼Œè¿”å›å€¼çš„æ–¹å¼ç›´æ¥æ“ä½œ SP åç§»å®ç°ï¼Œmain è°ƒç”¨ swap å‡½æ•°:

![](http://processon.com/chart_image/6010e2557d9c08426cf044c6.png)

```asm
"".main STEXT size=71 args=0x0 locals=0x28
  0x0000 00000 (main.go:8)	TEXT	"".main(SB), ABIInternal, $40-0
  ...
  0x000f 00015 (main.go:8)	SUBQ	$40, SP
  0x0013 00019 (main.go:8)	MOVQ	BP, 32(SP) // åŸºå€
  0x0018 00024 (main.go:8)	LEAQ	32(SP), BP
  ...
  0x001d 00029 (main.go:9)	MOVQ	$0, (SP)   // *
  0x0025 00037 (main.go:9)	MOVQ	$1, 8(SP)  // *
  0x002e 00046 (main.go:9)	PCDATA	$1, $0
  0x002e 00046 (main.go:9)	CALL	"".swap(SB)
  0x0033 00051 (main.go:10)	MOVQ	32(SP), BP // *
  0x0038 00056 (main.go:10)	ADDQ	$40, SP    // *
  0x003c 00060 (main.go:10)	RET
  ...
```


ç¼–å†™ä½¿ç”¨ç»“æ„ä½“çš„ä»£ç ï¼Œçœ‹çœ‹ new(Person) å’Œ &Person{} æœ‰æ— åŒºåˆ«:

```go
package main

type Person struct{}

func main() {
  // var p *Person = &Person{}
  p := &Person{}
  println(p)
}
```

æ ¸å¿ƒçš„æ±‡ç¼–ä»£ç æ˜¯:

```asm
0x0020 00032 (main.go:8)	CALL	runtime.printlock(SB)
0x0025 00037 (main.go:8)	LEAQ	""..autotmp_2+8(SP), AX
0x002a 00042 (main.go:8)	MOVQ	AX, (SP)
0x002e 00046 (main.go:8)	CALL	runtime.printpointer(SB)
0x0033 00051 (main.go:8)	CALL	runtime.printnl(SB)
0x0038 00056 (main.go:8)	CALL	runtime.printunlock(SB)
0x003d 00061 (main.go:9)	MOVQ	8(SP), BP
0x0042 00066 (main.go:9)	ADDQ	$16, SP
0x0046 00070 (main.go:9)	RET
```

å¦‚æœä½¿ç”¨ p := new(Person) æ ¸å¿ƒæ±‡ç¼–ä»£ç æ˜¯:

```asm
0x0020 00032 (main.go:9)	CALL	runtime.printlock(SB)
0x0025 00037 (main.go:9)	LEAQ	""..autotmp_1+8(SP), AX
0x002a 00042 (main.go:9)	MOVQ	AX, (SP)
0x002e 00046 (main.go:9)	CALL	runtime.printpointer(SB)
0x0033 00051 (main.go:9)	CALL	runtime.printnl(SB)
0x0038 00056 (main.go:9)	CALL	runtime.printunlock(SB)
0x003d 00061 (main.go:10)	MOVQ	8(SP), BP
0x0042 00066 (main.go:10)	ADDQ	$16, SP
0x0046 00070 (main.go:10)	RET
```

å¯è§ new(Person) å’Œ &Person{} æ²¡æœ‰æ€§èƒ½ä¸Šçš„åŒºåˆ«ï¼Œæ‰“å°ç»“æ„ä½“åœ°å€çš„æ±‡ç¼–:

```asm
0x0020 00032 (main.go:5)	CALL	runtime.printlock(SB)
0x0025 00037 (main.go:5)	LEAQ	""..autotmp_2+8(SP), AX
0x002a 00042 (main.go:5)	MOVQ	AX, (SP)
0x002e 00046 (main.go:5)	CALL	runtime.printpointer(SB)
0x0033 00051 (main.go:5)	CALL	runtime.printnl(SB)
0x0038 00056 (main.go:5)	CALL	runtime.printunlock(SB)
0x003d 00061 (main.go:6)	MOVQ	8(SP), BP
0x0042 00066 (main.go:6)	ADDQ	$16, SP
0x0046 00070 (main.go:6)	RET
```

å‰é¢ç« èŠ‚æµ‹è¯•è¿‡ï¼Œç©ºç»“æ„ä½“ä¸å ç”¨å†…å­˜ï¼Œç¼–è¯‘åæ˜¯ä¸€ä¸ªå›ºå®šçš„å†…å­˜åœ°å€ï¼Œåœ¨æ±‡ç¼–çº§åˆ«çœ‹çœ‹:


```asm
0x001d 00029 (main.go:7)	XORPS	X0, X0                    // æ¸…ç©º X0 å¯„å­˜å™¨
0x0020 00032 (main.go:7)	MOVUPS	X0, ""..autotmp_15+64(SP) // åˆå§‹åŒ–æ ˆä¸Šä¸´æ—¶ç©ºé—´
0x0025 00037 (main.go:7)	LEAQ	type.struct {}(SB), AX
0x002c 00044 (main.go:7)	MOVQ	AX, ""..autotmp_15+64(SP)
0x0031 00049 (main.go:7)	LEAQ	runtime.zerobase(SB), AX
0x0038 00056 (main.go:7)	MOVQ	AX, ""..autotmp_15+72(SP)
```

runtime.zerobase(SB) å°±æ˜¯ç©ºç»“æ„ä½“çš„å›ºå®šå†…å­˜åœ°å€ã€‚åµŒå¥—ç»“æ„ä½“å‚æ•°å¦‚ä½•ä¼ é€’å‘¢? æµ‹è¯•ä»£ç :

```go
type Rank struct {
  Level int
}

type Address struct {
  Rank
  StreetNo int
}

//go:noinline
func printAddr(addr Address) {
  println(addr.Level)
  println(addr.StreetNo)
}

func main() {
  printAddr(Address{Rank: Rank{Level: 1}, StreetNo: 1})
}
```

å¯è§è¢«åµŒå¥—çš„ç»“æ„ä½“ä¹ŸæŒ‰ç…§å­—æ®µä¼ é€’ï¼Œå’Œç›´æ¥æŠŠå­—æ®µå†™åœ¨ä¸€ä¸ªç»“æ„ä½“é‡Œæ²¡æœ‰åŒºåˆ«:


```asm
"".printAddr STEXT size=110 args=0x10 locals=0x10
  0x0000 00000 (main.go:12)	TEXT	"".printAddr(SB), ABIInternal, $16-16
  ...
  0x0020 00032 (main.go:13)	CALL	runtime.printlock(SB)
  0x0025 00037 (main.go:13)	MOVQ	"".addr+24(SP), AX
  0x002a 00042 (main.go:13)	MOVQ	AX, (SP)
  0x002e 00046 (main.go:13)	CALL	runtime.printint(SB)
  0x0033 00051 (main.go:13)	CALL	runtime.printnl(SB)
  0x0038 00056 (main.go:13)	CALL	runtime.printunlock(SB)
  0x003d 00061 (main.go:13)	NOP
  0x0040 00064 (main.go:14)	CALL	runtime.printlock(SB)
  0x0045 00069 (main.go:14)	MOVQ	"".addr+32(SP), AX
  0x004a 00074 (main.go:14)	MOVQ	AX, (SP)
  0x004e 00078 (main.go:14)	CALL	runtime.printint(SB)
  0x0053 00083 (main.go:14)	CALL	runtime.printnl(SB)
  0x0058 00088 (main.go:14)	CALL	runtime.printunlock(SB)
  0x005d 00093 (main.go:15)	MOVQ	8(SP), BP
  0x0062 00098 (main.go:15)	ADDQ	$16, SP
  0x0066 00102 (main.go:15)	RET

"".main STEXT size=71 args=0x0 locals=0x18
  0x0000 00000 (main.go:18)	TEXT	"".main(SB), ABIInternal, $24-0
  ...
  0x001d 00029 (main.go:19)	MOVQ	$1, (SP)
  0x0025 00037 (main.go:19)	MOVQ	$1, 8(SP)
  0x002e 00046 (main.go:19)	PCDATA	$1, $0
  0x002e 00046 (main.go:19)	CALL	"".printAddr(SB)
  0x0033 00051 (main.go:20)	MOVQ	16(SP), BP
  0x0038 00056 (main.go:20)	ADDQ	$24, SP
  0x003c 00060 (main.go:20)	RET
```

ä¼ é€’æ•°ç»„å‚æ•°ï¼Œä¸ºäº†å‡½æ•°ä½“ç®€å•ï¼Œåªæ‰“å°äº†ç¬¬ä¸€ä¸ªå…ƒç´ :


```asm
func printArray(data [3]int) { 
  print(data[0])
}

"".printArray STEXT size=80 args=0x18 locals=0x18
  0x0000 00000 (array.go:3) TEXT  "".printArray(SB), ABIInternal, $24-24
  ...
  0x001d 00029 (array.go:4) MOVQ  "".data+32(SP), AX      // * åŠ ä¸Š ret å’Œ bp çš„ 16ï¼Œå®šä½ç¬¬ 0 ä¸ªå…ƒç´ 
  0x0022 00034 (array.go:4) MOVQ  AX, ""..autotmp_2+8(SP)
  0x0027 00039 (array.go:4) PCDATA  $1, $0
  0x0027 00039 (array.go:4) CALL  runtime.printlock(SB)
  0x002c 00044 (array.go:4) MOVQ  ""..autotmp_2+8(SP), AX
  0x0031 00049 (array.go:4) MOVQ  AX, (SP)
  0x0035 00053 (array.go:4) CALL  runtime.printint(SB)
  0x003a 00058 (array.go:4) CALL  runtime.printunlock(SB)
  0x003f 00063 (array.go:5) MOVQ  16(SP), BP
  0x0044 00068 (array.go:5) ADDQ  $24, SP
  0x0048 00072 (array.go:5) RET
  ...
  0x004e 00078 (array.go:3) JMP 0

"".main STEXT size=77 args=0x0 locals=0x20
  0x0000 00000 (array.go:8)	TEXT	"".main(SB), ABIInternal, $32-0
  ...
  0x001d 00029 (array.go:9)	MOVQ	$1, (SP)
  0x0025 00037 (array.go:9)	MOVQ	$2, 8(SP)
  0x002e 00046 (array.go:9)	MOVQ	$3, 16(SP)
  0x0037 00055 (array.go:9)	PCDATA	$1, $0
  0x0037 00055 (array.go:9)	CALL	"".printArray(SB)
  ...
```

æŠŠæ•°ç»„çš„æ¯ä¸ªå€¼ä»å³åˆ°å·¦éƒ½æ”¾åˆ°æ ˆä¸Š(ç±»ä¼¼ N ä¸ªå‚æ•°)ï¼Œåˆ‡ç‰‡å’Œæ•°ç»„çš„åŒºåˆ«æ˜¯å¾ˆå¤§çš„ï¼Œçœ‹çœ‹ slice åˆ‡ç‰‡å¦‚ä½•ä¼ é€’çš„:

```go
package main

import "fmt"

//go:noinline
func printSlice(slice []int) {
  fmt.Println(slice)
}

func main() {
  printSlice([]int{1, 2, 3})
}
```

å¯¹åº”çš„ main çš„æ±‡ç¼–ä»£ç :

```asm
"".main STEXT size=118 args=0x0 locals=0x20
  0x0000 00000 (main.go:10)	TEXT	"".main(SB), ABIInternal, $32-0
  ...
  0x000f 00015 (main.go:10)     SUBQ    $32, SP
  0x0013 00019 (main.go:10)     MOVQ    BP, 24(SP)
  0x0018 00024 (main.go:10)     LEAQ    24(SP), BP
  ...
  0x001d 00029 (main.go:11)	LEAQ	type.[3]int(SB), AX
  0x0024 00036 (main.go:11)	MOVQ	AX, (SP)
  0x0028 00040 (main.go:11)	PCDATA	$1, $0
  0x0028 00040 (main.go:11)	CALL	runtime.newobject(SB)
  0x002d 00045 (main.go:11)	MOVQ	8(SP), AX
  0x0032 00050 (main.go:11)	MOVQ	$1, (AX)    // å…ƒç´ 1  8(SP)
  0x0039 00057 (main.go:11)	MOVQ	$2, 8(AX)   // å…ƒç´ 2 16(SP)
  0x0041 00065 (main.go:11)	MOVQ	$3, 16(AX)  // å…ƒç´ 3 24(SP)
  0x0049 00073 (main.go:11)	MOVQ	AX, (SP)    // Data åœ°å€
  0x004d 00077 (main.go:11)	MOVQ	$3, 8(SP)   // Len å¤§å°
  0x0056 00086 (main.go:11)	MOVQ	$3, 16(SP)  // Cap å¤§å°
  0x005f 00095 (main.go:11)	NOP
  0x0060 00096 (main.go:11)	CALL	"".printSlice(SB)
  0x0065 00101 (main.go:12)	MOVQ	24(SP), BP
  0x006a 00106 (main.go:12)	ADDQ	$32, SP
  0x006e 00110 (main.go:12)	RET
```

å¯¹åº” reflect.SliceHedaer  å’Œ runtime.newobject(SB) çš„å®šä¹‰:

```go
type SliceHeader struct {
  Data uintptr
  Len  int
  Cap  int
}

func newobject(typ *_type) unsafe.Pointer {
  return mallocgc(typ.size, typ, true)
}
```

åˆå§‹åŒ– slice æœ‰ä¸‰ä¸ªå…ƒç´ å€¼æŒ‡å‘å †ä¸­çš„åœ°å€ï¼Œè°ƒç”¨çš„æ—¶å€™ä¹Ÿæ˜¯ä¼ å…¥ä¸‰ä¸ªå€¼ï¼Œå®é™…çš„å€¼é€šè¿‡ *AX æŒ‡å‘çš„å†…å­˜åŒºåŸŸ (AX) æ¥æ“ä½œï¼Œ$3 æ˜¯å› ä¸ºåˆ‡ç‰‡çš„ len å’Œ cap éƒ½æ˜¯ 3ï¼Œåˆ‡ç‰‡çš„ä¸‰ä¸ªæˆå‘˜å­—æ®µéƒ½è¢«å¤åˆ¶ï¼Œè¿™æ®µä»£ç ä¸å¤šï¼Œä½†æ˜¯æ ˆå˜åŒ–æ¯”è¾ƒå¤æ‚:

![](http://processon.com/chart_image/6010fc21f346fb1b2a5cf2b4.png)

è¢«è°ƒç”¨å‚æ•°çš„å¤„ç†:

```asm
"".printSlice STEXT size=175 args=0x18 locals=0x58
  0x0000 00000 (main.go:6)	TEXT	"".printSlice(SB), ABIInternal, $88-24
  0x0000 00000 (main.go:6)	MOVQ	(TLS), CX
  0x0009 00009 (main.go:6)	CMPQ	SP, 16(CX)
  0x000d 00013 (main.go:6)	PCDATA	$0, $-2
  0x000d 00013 (main.go:6)	JLS	165
  0x0013 00019 (main.go:6)	PCDATA	$0, $-1
  0x0013 00019 (main.go:6)	SUBQ	$88, SP
  0x0017 00023 (main.go:6)	MOVQ	BP, 80(SP)             // åŸºå€
  0x001c 00028 (main.go:6)	LEAQ	80(SP), BP
  ...
  0x0021 00033 (main.go:7)	MOVQ	"".slice+96(SP), AX    // *
  0x0026 00038 (main.go:7)	MOVQ	AX, (SP)
  0x002a 00042 (main.go:7)	MOVQ	"".slice+104(SP), AX   // * 
  0x002f 00047 (main.go:7)	MOVQ	AX, 8(SP)
  0x0034 00052 (main.go:7)	MOVQ	"".slice+112(SP), AX   // *
  0x0039 00057 (main.go:7)	MOVQ	AX, 16(SP)
  0x003e 00062 (main.go:7)	PCDATA	$1, $1
  0x003e 00062 (main.go:7)	NOP
  0x0040 00064 (main.go:7)	CALL	runtime.convTslice(SB) // *
  0x0045 00069 (main.go:7)	MOVQ	24(SP), AX             // *
  0x004a 00074 (main.go:7)	XORPS	X0, X0
  0x004d 00077 (main.go:7)	MOVUPS	X0, ""..autotmp_13+64(SP)
  0x0052 00082 (main.go:7)	LEAQ	type.[]int(SB), CX
  0x0059 00089 (main.go:7)	MOVQ	CX, ""..autotmp_13+64(SP)
  0x005e 00094 (main.go:7)	MOVQ	AX, ""..autotmp_13+72(SP)
```

æ³¨æ„ runtime.convTslice æŠŠæ™®é€šç±»å‹è½¬æ¢æˆåˆ‡ç‰‡ç»“æ„:

```go
// src/cmd/compile/internal/gc/builtin/runtime.go
func convTslice(val any) unsafe.Pointer

// src/runtime/iface.go
func convTslice(val []byte) (x unsafe.Pointer) {
  if (*slice)(unsafe.Pointer(&val)).array == nil {
    x = unsafe.Pointer(&zeroVal[0])
  } else {
    x = mallocgc(unsafe.Sizeof(val), sliceType, true)
    *(*[]byte)(x) = val
  }
   
  return
}

// sliceType 
sliceType  *_type = efaceOf(&sliceEface)._type

func efaceOf(ep *interface{}) *eface {
  return (*eface)(unsafe.Pointer(ep))
}

// eface
type eface struct {
  _type *_type
  data  unsafe.Pointer
}
```


æœ€åçœ‹çœ‹ defer æ’å…¥çš„ä»£ç :

```go
package main

func f() int {
  i := 0

  defer func(val int) {
    val++
    println(val)
  }(i)

  return i
}
```

æ±‡ç¼–åè°ƒç”¨ runtime.deferreturn(SB):

```asm
"".f STEXT size=144 args=0x8 locals=0x28
  0x0029 00041 (defer.go:3)   MOVB  $0, ""..autotmp_3+15(SP)
  0x002e 00046 (defer.go:3)   MOVQ  $0, "".~r0+48(SP)
  0x0037 00055 (defer.go:6)   LEAQ  "".f.func1Â·f(SB), AX          // *
  0x003e 00062 (defer.go:6)   MOVQ  AX, ""..autotmp_4+24(SP)
  0x0043 00067 (defer.go:6)   MOVQ  $0, ""..autotmp_5+16(SP)
  0x004c 00076 (defer.go:6)   MOVB  $1, ""..autotmp_3+15(SP)
  0x0051 00081 (defer.go:10)  MOVQ  $0, "".~r0+48(SP)
  0x005a 00090 (defer.go:10)  MOVB  $0, ""..autotmp_3+15(SP)
  0x005f 00095 (defer.go:10)  MOVQ  ""..autotmp_5+16(SP), AX
  0x0064 00100 (defer.go:10)  MOVQ  AX, (SP)
  0x0068 00104 (defer.go:10)  PCDATA  $1, $1
  0x0068 00104 (defer.go:10)  CALL  "".f.func1(SB)                // *
  0x006d 00109 (defer.go:10)  MOVQ  32(SP), BP
  0x0072 00114 (defer.go:10)  ADDQ  $40, SP
  0x0076 00118 (defer.go:10)  RET
  0x0077 00119 (defer.go:10)  CALL  runtime.deferreturn(SB)       // *
  0x007c 00124 (defer.go:10)  MOVQ  32(SP), BP
  0x0081 00129 (defer.go:10)  ADDQ  $40, SP
  0x0085 00133 (defer.go:10)  RET

"".f.func1 STEXT size=86 args=0x8 locals=0x10
  0x0020 00032 (right.go:9)   CALL	runtime.printlock(SB)
  0x0025 00037 (right.go:8)   MOVQ	"".val+24(SP), AX         //*
  0x002a 00042 (right.go:8)   INCQ	AX
  0x002d 00045 (right.go:9)   MOVQ	AX, (SP)
  0x0031 00049 (right.go:9)   CALL	runtime.printint(SB)
  0x0036 00054 (right.go:9)   CALL	runtime.printnl(SB)
  0x003b 00059 (right.go:9)   NOP
  0x0040 00064 (right.go:9)   CALL	runtime.printunlock(SB)
  0x0045 00069 (right.go:10)  MOVQ	8(SP), BP
  0x004a 00074 (right.go:10)  ADDQ	$16, SP
  0x004e 00078 (right.go:10)  RET
```

ä¸å¸Œæœ›çš„ç‰ˆæœ¬:

```go
package main 

func f() {
  i := 0

  defer func() {
    println(i) // 1
  }()

  i++
}
```

æ±‡ç¼–ä»£ç å¦‚ä¸‹:

```asm
"".f STEXT size=145 args=0x0 locals=0x30
  0x0025 00037 (wrong.go:3)   MOVB  $0, ""..autotmp_2+15(SP)
  0x002a 00042 (wrong.go:4)   MOVQ  $0, "".i+16(SP)
  0x0033 00051 (wrong.go:6)   LEAQ  "".f.func1Â·f(SB), AX
  0x003a 00058 (wrong.go:6)   MOVQ  AX, ""..autotmp_3+32(SP)
  0x003f 00063 (wrong.go:6)   LEAQ  "".i+16(SP), AX
  0x0044 00068 (wrong.go:6)   MOVQ  AX, ""..autotmp_4+24(SP)
  0x0049 00073 (wrong.go:6)   MOVB  $1, ""..autotmp_2+15(SP)
  0x004e 00078 (wrong.go:10)  MOVQ  "".i+16(SP), AX
  0x0053 00083 (wrong.go:10)  INCQ  AX
  0x0056 00086 (wrong.go:10)  MOVQ  AX, "".i+16(SP)
  0x005b 00091 (wrong.go:11)  MOVB  $0, ""..autotmp_2+15(SP)
  0x0060 00096 (wrong.go:11)  MOVQ  ""..autotmp_4+24(SP), AX
  0x0065 00101 (wrong.go:11)  MOVQ  AX, (SP)
  0x0069 00105 (wrong.go:11)  PCDATA  $1, $1
  0x0069 00105 (wrong.go:11)  CALL  "".f.func1(SB)
  0x006e 00110 (wrong.go:11)  MOVQ  40(SP), BP
  0x0073 00115 (wrong.go:11)  ADDQ  $48, SP
  0x0077 00119 (wrong.go:11)  RET
  0x0078 00120 (wrong.go:11)  CALL  runtime.deferreturn(SB)
  0x007d 00125 (wrong.go:11)  MOVQ  40(SP), BP
  0x0082 00130 (wrong.go:11)  ADDQ  $48, SP
  0x0086 00134 (wrong.go:11)  RET

"".f.func1 STEXT size=86 args=0x8 locals=0x10
  0x0020 00032 (wrong.go:7) CALL  runtime.printlock(SB)
  0x0025 00037 (wrong.go:7) MOVQ  "".&i+24(SP), AX      // *
  0x002a 00042 (wrong.go:7) MOVQ  (AX), AX
  0x002d 00045 (wrong.go:7) MOVQ  AX, (SP)
  0x0031 00049 (wrong.go:7) PCDATA  $1, $1
  0x0031 00049 (wrong.go:7) CALL  runtime.printint(SB)
  0x0036 00054 (wrong.go:7) CALL  runtime.printnl(SB)
  0x003b 00059 (wrong.go:7) NOP
  0x0040 00064 (wrong.go:7) CALL  runtime.printunlock(SB)
  0x0045 00069 (wrong.go:8) MOVQ  8(SP), BP
  0x004a 00074 (wrong.go:8) ADDQ  $16, SP
  0x004e 00078 (wrong.go:8) RET
```


é€ƒé€¸åˆ†ææ„æ€æ˜¯ç¼–è¯‘å™¨å¯¹ä»£ç è¿›è¡Œåˆ†æï¼Œå‘ç°æŸäº›åˆ†é…åœ¨å †ä¸Šçš„å¯¹è±¡æ²¡æœ‰å¿…è¦è½¬ä¸ºåˆ†é…åœ¨æ ˆä¸Šï¼Œæˆ–è€…çœ‹èµ·æ¥æ˜¯åˆ†é…åˆ°æ ˆä¸Šçš„å¯¹è±¡éœ€è¦æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸï¼Œè½¬è€Œåˆ†é…åˆ°å †ä¸Šã€‚

```go
// go build -gcflags=-m main.go
func foo1() *person {
  // åˆ†é…åˆ°å †ä¸Š
  return &person{Name: "zhangsan"}
}

/*
  0x001d 00029 (main.go:9)  LEAQ  type."".person(SB), AX
  0x0024 00036 (main.go:9)  MOVQ  AX, (SP)
  0x0028 00040 (main.go:9)  PCDATA  $1, $0
  0x0028 00040 (main.go:9)  CALL  runtime.newobject(SB)
  0x002d 00045 (main.go:9)  MOVQ  8(SP), AX
  0x0032 00050 (main.go:9)  MOVQ  $8, 8(AX)
  0x003a 00058 (main.go:9)  LEAQ  go.string."zhangsan"(SB), CX
  0x0041 00065 (main.go:9)  MOVQ  CX, (AX)
  0x0044 00068 (main.go:9)  MOVQ  AX, "".~r0+32(SP)
  0x0049 00073 (main.go:9)  MOVQ  16(SP), BP
  0x004e 00078 (main.go:9)  ADDQ  $24, SP
*/
```

ä¸‹é¢çš„å¯¹è±¡æ˜¯ä½¿ç”¨ new å‡½æ•°åˆ†é…çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨æ˜¯åœ¨ä¸ºæœŸåˆ†é…åˆ°æ ˆä¸Šï¼Œä¹Ÿå¯ä½¿ç”¨ go build -gcflags=-m main.go æ¥æŸ¥çœ‹ç¼–è¯‘å™¨çš„åˆ†æã€‚

```go
// go build -gcflags=-m main.go
// new(person) does not escape
func foo3() {
  // åˆ†é…åˆ°æ ˆä¸Š
  p := new(person)
  p.Name = "zhangsan"
  println(p)
}

/*
  0x0020 00032 (main.go:21) CALL  runtime.printlock(SB)
  0x0025 00037 (main.go:21) LEAQ  go.string."zhangsan"(SB), AX
  0x002c 00044 (main.go:21) MOVQ  AX, (SP)
  0x0030 00048 (main.go:21) MOVQ  $8, 8(SP)
  0x0039 00057 (main.go:21) CALL  runtime.printstring(SB)
  0x003e 00062 (main.go:21) NOP
  0x0040 00064 (main.go:21) CALL  runtime.printnl(SB)
  0x0045 00069 (main.go:21) CALL  runtime.printunlock(SB)
  0x004a 00074 (main.go:22) MOVQ  16(SP), BP
  0x004f 00079 (main.go:22) ADDQ  $24, SP
  0x0053 00083 (main.go:22) RET
*/
```

ä¸è¿‡ï¼Œæ”¹ä¸€ä¸‹è¿™ä¸ªæ‰“å°å‡½æ•°ï¼Œnew(person) å°±ä¼š escapses to heapï¼Œä¿®æ”¹å¦‚ä¸‹:

```go
// go build -gcflags=-m main.go
// new(person) escapes to heap
func foo3_1() {
  // åˆ†é…åˆ°å †ä¸Š
  p := new(person)
  p.Name = "zhangsan"
  // ä¼ é€’çš„æ˜¯ []interface{}
  fmt.Printf("%v", p)
}
```

åŸå› æ˜¯ fmt.Printf å‡½æ•°ä¼ é€’çš„ä¸å®šå‚æ•°æ˜¯ []interfaceï¼Œp é€šè¿‡åœ°å€è½¬æ¢è¿‡å»ï¼Œä¸è¿‡äº‹æƒ…å¹¶ä¸æ€»æ˜¯åƒçœ‹åˆ°çš„è¿™æ ·ï¼Œä¸‹é¢çš„å‡½æ•°æŒ‰é“ç†æ˜¯åˆ†é…åˆ°å †ä¸Š:

```go
type point struct {
  x, y int
}

func move(p *point) {
  p.x = 10
  p.y = 10
}

func main() {
  // åˆ†é…åˆ°æ ˆä¸Šï¼Œæ³¨æ„ move å‡½æ•°è¢«å†…æ•›äº†
  p := new(point)
  move(p)
  print(p)
}
```

å…ˆä½¿ç”¨ go build -gcflags=-m main.go åˆ†æï¼Œç»“æœæ˜¾ç¤º:

```
./main.go:13:6: can inline move
./main.go:34:6: can inline main
./main.go:37:6: inlining call to move
./main.go:13:11: p does not escape
./main.go:36:10: new(point) does not escape
```

æ³¨æ„ p å’Œ new(point) éƒ½æ˜¯ does not escapeï¼Œä¸ºä»€ä¹ˆå‘¢? å› ä¸º move å‡½æ•°è¢« inline äº†(å¯ä»¥ä½¿ç”¨ //go:noinline å–æ¶ˆå†…æ•›)ï¼Œmain å‡½æ•°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹:

```
/*
  0x001d 00029 (main.go:15) XORPS X0, X0
  0x0020 00032 (main.go:14) MOVUPS  X0, ""..autotmp_2+8(SP)
  0x0025 00037 (<unknown line number>)  NOP
  0x0025 00037 (main.go:8)  MOVQ  $10, ""..autotmp_2+8(SP)
  0x002e 00046 (main.go:9)  MOVQ  $10, ""..autotmp_2+16(SP)
  0x0037 00055 (main.go:16) PCDATA  $1, $0
  0x0037 00055 (main.go:16) CALL  runtime.printlock(SB)
  0x003c 00060 (main.go:16) LEAQ  ""..autotmp_2+8(SP), AX
  0x0041 00065 (main.go:16) MOVQ  AX, (SP)
  0x0045 00069 (main.go:16) CALL  runtime.printpointer(SB)
  0x004a 00074 (main.go:16) CALL  runtime.printunlock(SB)
  0x004f 00079 (main.go:17) MOVQ  24(SP), BP
  0x0054 00084 (main.go:17) ADDQ  $32, SP
  0x0058 00088 (main.go:17) RET
*/
```

æ±‡ç¼–ä»£ç ä¸­è°ƒç”¨çš„ runtime.xxx å‡½æ•°æºä»£ç åœ¨å“ªé‡Œå‘¢? å‚è€ƒ [https://github.com/golang/go/tree/master/src/runtime](https://github.com/golang/go/tree/master/src/runtime)

æœ¬ç« èŠ‚çš„ä»£ç  [https://github.com/developdeveloper/go-demo/tree/master/29-decompile-memory](https://github.com/developdeveloper/go-demo/tree/master/29-decompile-memory)
